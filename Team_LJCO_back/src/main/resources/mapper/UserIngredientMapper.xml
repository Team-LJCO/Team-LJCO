<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.team_ljco.mapper.UserIngredientMapper">

    <resultMap id="UserIngredientResultMap" type="com.korit.team_ljco.entity.UserIngredient">
        <id property="userIngId" column="user_ing_id"/>
        <result property="userId" column="user_id"/>
        <result property="ingId" column="ing_id"/>
        <result property="userIngAmt" column="user_ing_amt"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="ingredient" javaType="com.korit.team_ljco.entity.Ingredient">
            <id property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
            <result property="ingCatId" column="ing_cat_id"/>
            <result property="ingImgUrl" column="ing_img_url"/>
        </association>
    </resultMap>

    <resultMap id="IngredientsByUser"
               type="com.korit.team_ljco.dto.UserIngredientResponse">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
        <result property="totalCount" column="total_count"/>
        <collection property="userIngredients" ofType="com.korit.team_ljco.dto.IngredientByUserResponse">
            <result property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
        </collection>
    </resultMap>

    <select id="countExpiredIngredients" parameterType="long" resultType="int">
        SELECT count(*)
        FROM user_ingredients ui
        WHERE ui.user_id = #{userId}
        AND DATEDIFF(CURRENT_DATE, ui.created_at) >= 15
    </select>

    <select id="getMatchedRecipes" resultMap="IngredientsByUser">
        SELECT
        r.rcp_id,
        r.rcp_name,
        r.rcp_img_url,
        r.rcp_view_count,
        r.level,
        r.total_count,
        i.ing_id,
        i.ing_name
        FROM
        (
        SELECT
        rcp.rcp_id,
        rcp.rcp_name,
        rcp.rcp_img_url,
        rcp.rcp_view_count,
        rcp.level,
        count(*) over() as total_count
        FROM rcp rcp
        JOIN rcp_ing ri ON ri.rcp_id = rcp.rcp_id
        LEFT JOIN user_ingredients ui ON ui.user_id = #{userId} AND ui.ing_id = ri.ing_id
        GROUP BY
        rcp.rcp_id, rcp.rcp_name, rcp.rcp_img_url, rcp.rcp_view_count, rcp.level
        HAVING count(distinct ui.ing_id) = count(distinct ri.ing_id)
        ORDER BY rcp.rcp_view_count DESC
        LIMIT #{limit}
        ) r
        JOIN rcp_ing ri ON ri.rcp_id = r.rcp_id
        JOIN ingredients i ON i.ing_id = ri.ing_id
    </select>

    <select id="selectUserIngredients" resultMap="UserIngredientResultMap">
        SELECT
        ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
        ui.created_at, ui.updated_at,
        i.ing_name, i.ing_cat_id, i.ing_img_url,
        DATEDIFF(CURRENT_DATE, ui.created_at) AS diff_days
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_id = #{userId}
        ORDER BY
        CASE WHEN DATEDIFF(CURRENT_DATE, ui.created_at) = 0 THEN 0 ELSE 1 END ASC,
        CASE i.ing_cat_id
        WHEN 1  THEN 1   WHEN 13 THEN 1   WHEN 9  THEN 1
        WHEN 12 THEN 1   WHEN 15 THEN 1   WHEN 6  THEN 1
        WHEN 2  THEN 1   WHEN 3  THEN 1   WHEN 8  THEN 1
        WHEN 5  THEN 2
        WHEN 10 THEN 3   WHEN 7  THEN 3   WHEN 16 THEN 3   WHEN 11 THEN 3
        WHEN 14 THEN 4   WHEN 17 THEN 4
        ELSE 99
        END ASC,
        diff_days DESC
    </select>

    <select id="selectUserIngredientById" parameterType="long" resultMap="UserIngredientResultMap">
        SELECT
        ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
        ui.created_at, ui.updated_at,
        i.ing_name, i.ing_cat_id, i.ing_img_url
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_ing_id = #{userIngId}
    </select>

    <select id="selectUserIngredientByUserAndIng" resultMap="UserIngredientResultMap">
        SELECT
        ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
        ui.created_at, ui.updated_at,
        i.ing_name, i.ing_cat_id, i.ing_img_url
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_id = #{userId} AND ui.ing_id = #{ingId}
    </select>

    <insert id="insertUserIngredient" parameterType="com.korit.team_ljco.entity.UserIngredient"
            useGeneratedKeys="true" keyProperty="userIngId">
        INSERT INTO user_ingredients (user_id, ing_id, user_ing_amt)
        VALUES (#{userId}, #{ingId}, #{userIngAmt})
    </insert>

    <!--재료 목록받아서 추가-->
    <insert id="insertIngredientsByNames">
        INSERT INTO user_ingredients (user_id, ing_id, user_ing_amt, created_at)
        SELECT #{userId}, ing_id, 1.00, CURRENT_TIMESTAMP
        FROM ingredients
        WHERE ing_name IN
        <foreach collection="ingredientNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </insert>

    <update id="updateUserIngredient" parameterType="com.korit.team_ljco.entity.UserIngredient">
        UPDATE user_ingredients
        SET user_ing_amt = #{userIngAmt}, updated_at = CURRENT_TIMESTAMP
        WHERE user_ing_id = #{userIngId}
    </update>

    <delete id="deleteUserIngredient" parameterType="long">
        DELETE FROM user_ingredients WHERE user_ing_id = #{userIngId}
    </delete>

    <delete id="deleteUserIngredientsByUser" parameterType="long">
        DELETE FROM user_ingredients WHERE user_id = #{userId}
    </delete>

    <!--재료 목록받아서 삭제-->
    <delete id="deleteIngredientsByNames">

        DELETE FROM user_ingredients
        WHERE user_id = #{userId}
        AND ing_id IN (
        SELECT ing_id
        FROM ingredients
        WHERE ing_name IN
        <foreach collection="ingredientNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
        )
    </delete>

    <select id="countUserIngredients" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM user_ingredients WHERE user_id = #{userId}
    </select>

</mapper>