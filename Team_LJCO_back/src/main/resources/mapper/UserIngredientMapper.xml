<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.team_ljco.mapper.UserIngredientMapper">

    <resultMap id="UserIngredientResultMap" type="com.korit.team_ljco.entity.UserIngredient">
        <id property="userIngId" column="user_ing_id"/>
        <result property="userId" column="user_id"/>
        <result property="ingId" column="ing_id"/>
        <result property="userIngAmt" column="user_ing_amt"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="ingredient" javaType="com.korit.team_ljco.entity.Ingredient">
            <id property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
            <result property="ingCatId" column="ing_cat_id"/>
            <result property="ingImgUrl" column="ing_img_url"/>
        </association>
    </resultMap>

    <resultMap id="IngredientsByUser"
               type="com.korit.team_ljco.dto.UserIngredientResponse">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
        <result property="totalCount" column="total_count"/>
        <collection property="userIngredients" ofType="com.korit.team_ljco.dto.IngredientByUserResponse">
            <result property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
        </collection>
    </resultMap>



    <select id="countExpiredIngredients" parameterType="long" resultType="int">
        select count(*)
        from user_ingredients ui
        where ui.user_id = #{userId}
        and datediff(current_date, ui.created_at) >= 15
    </select>

    <select id="getMatchedRecipes"  resultMap="IngredientsByUser">
        select
            r.rcp_id,
            r.rcp_name,
            r.rcp_img_url,
            r.rcp_view_count,
            r.level,
            r.total_count,
            i.ing_id,
            i.ing_name
        from
        (
        select
            rcp.rcp_id,
            rcp.rcp_name,
            rcp.rcp_img_url,
            rcp.rcp_view_count,
            rcp.level,
            count(*) over() as total_count
        from rcp rcp
        join rcp_ing ri
        on ri.rcp_id = rcp.rcp_id
        left join user_ingredients ui
        on ui.user_id = #{userId}
        and ui.ing_id = ri.ing_id
        group by
            rcp.rcp_id, rcp.rcp_name,rcp.rcp_img_url, rcp.rcp_view_count, rcp.level
        having count(distinct ui.ing_id) = count(distinct ri.ing_id)
        order by rcp.rcp_view_count desc
        limit #{limit}
        ) r
        join rcp_ing ri
        on ri.rcp_id = r.rcp_id
        join ingredients i
        on i.ing_id = ri.ing_id
    </select>



    <!-- 사용자 재료 전체 조회 -->
    <select id="selectUserIngredients" resultMap="UserIngredientResultMap">
        SELECT
        ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
        ui.created_at, ui.updated_at,
        i.ing_name, i.ing_cat_id, i.ing_img_url
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_id = #{userId}
        ORDER BY
        -- 1순위: 요청하신 그룹별 우선순위
        CASE i.ing_cat_id
        WHEN 1  THEN 1  -- 소고기
        WHEN 13 THEN 2  -- 돼지고기
        WHEN 9  THEN 3  -- 닭고기
        -- 그룹 4: 해산물, 육류, 달걀/유제품 (동일 가중치 4 부여)
        WHEN 12 THEN 4
        WHEN 15 THEN 4
        WHEN 6  THEN 4
        -- 그룹 5: 채소, 과일, 버섯 (동일 가중치 5 부여)
        WHEN 2  THEN 5
        WHEN 8  THEN 5
        WHEN 3  THEN 5
        WHEN 5  THEN 6  -- 가공식품류
        -- 그룹 7: 건어물, 쌀, 곡류, 콩/견과류 (동일 가중치 7 부여)
        WHEN 10 THEN 7
        WHEN 7  THEN 7
        WHEN 16 THEN 7
        WHEN 11 THEN 7
        -- 그룹 8: 밀가루/전분, 양념/소스류
        WHEN 14 THEN 8
        WHEN 17 THEN 8
        ELSE 99
        END ASC,
        -- 2순위: 같은 그룹 내에서는 등록일이 오래된 순(D+ 높은 순)
        ui.created_at ASC
    </select>



    <!-- ID로 사용자 재료 조회 -->
    <select id="selectUserIngredientById" parameterType="long" resultMap="UserIngredientResultMap">
        SELECT 
            ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
            ui.created_at, ui.updated_at,
            i.ing_name, i.ing_cat_id, i.ing_img_url
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_ing_id = #{userIngId}
    </select>

    <!-- 사용자와 재료로 조회 -->
    <select id="selectUserIngredientByUserAndIng" resultMap="UserIngredientResultMap">
        SELECT 
            ui.user_ing_id, ui.user_id, ui.ing_id, ui.user_ing_amt,
            ui.created_at, ui.updated_at,
            i.ing_name, i.ing_cat_id, i.ing_img_url
        FROM user_ingredients ui
        INNER JOIN ingredients i ON ui.ing_id = i.ing_id
        WHERE ui.user_id = #{userId} AND ui.ing_id = #{ingId}
    </select>

    <!-- 사용자 재료 등록 -->
    <insert id="insertUserIngredient" parameterType="com.korit.team_ljco.entity.UserIngredient"
            useGeneratedKeys="true" keyProperty="userIngId">
        INSERT INTO user_ingredients (
            user_id, ing_id, user_ing_amt
        ) VALUES (
            #{userId}, #{ingId}, #{userIngAmt}
        )
    </insert>

    <!-- 사용자 재료 수정 -->
    <update id="updateUserIngredient" parameterType="com.korit.team_ljco.entity.UserIngredient">
        UPDATE user_ingredients
        SET
            user_ing_amt = #{userIngAmt},
            updated_at = CURRENT_TIMESTAMP
        WHERE user_ing_id = #{userIngId}
    </update>

    <!-- 사용자 재료 삭제 -->
    <delete id="deleteUserIngredient" parameterType="long">
        DELETE FROM user_ingredients
        WHERE user_ing_id = #{userIngId}
    </delete>

    <!-- 사용자의 모든 재료 삭제 -->
    <delete id="deleteUserIngredientsByUser" parameterType="long">
        DELETE FROM user_ingredients
        WHERE user_id = #{userId}
    </delete>

    <!-- 사용자 재료 수 -->
    <select id="countUserIngredients" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM user_ingredients
        WHERE user_id = #{userId}
    </select>

</mapper>
