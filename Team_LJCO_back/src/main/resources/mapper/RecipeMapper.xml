<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.team_ljco.mapper.RecipeMapper">

    <!-- Recipe ResultMap 추가 (누락되어 있었음!) -->
    <resultMap id="RecipeResultMap" type="com.korit.team_ljco.entity.Recipe">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
    </resultMap>

    <!-- RecipeStep ResultMap -->
    <resultMap id="RecipeStepResultMap" type="com.korit.team_ljco.entity.RecipeStep">
        <id property="stepId" column="step_id"/>
        <result property="rcpId" column="rcp_id"/>
        <result property="stepNo" column="step_no"/>
        <result property="stepDesc" column="step_desc"/>
        <result property="stepImgUrl" column="step_img_url"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <resultMap id="RecipeListMap"
               type="com.korit.team_ljco.dto.RecipeListResponse">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
        <result property="matchRate" column="match_rate"/>
        <result property="totalCount" column="total_count"/>

        <collection property="ingredients" ofType="com.korit.team_ljco.entity.RecipeIngredientMatch">
            <id property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
            <result property="matchedIngId" column="matched_ing_id"/>
            <result property="redMatchedIng" column="redmatched_ing"/>
        </collection>
    </resultMap>


    <select id="getRecipes" resultMap="RecipeListMap">
        SELECT
            r.rcp_id,
            r.rcp_name,
            r.rcp_img_url,
            r.rcp_view_count,
            r.level,
            r.match_rate,
            r.total_count,
            i.ing_id,
            i.ing_name,
            ui.ing_id as matched_ing_id,
            ui2.ing_id as redmatched_ing
        from (
            select rcp_id, rcp_name, rcp_img_url, rcp_view_count,level, count(*) over() as total_count,
        (
        select count(ui2.ing_id) / count(ri2.ing_id) * 100
        from rcp_ing ri2
        left join user_ingredients ui2
        on ui2.ing_id = ri2.ing_id
        and ui2.user_id = #{userId}
        where ri2.rcp_id = rcp.rcp_id
        ) as match_rate
        from rcp rcp
        <choose>
            <when test="sort == 'VIEW_DESC'">
                order by rcp_view_count desc
            </when>
            <when test="sort == 'LEVEL_DESC'">
                order by level desc
            </when>
            <when test="sort == 'MATCHRATE_DESC'">
                order by match_rate desc
            </when>
            <otherwise>
                order by rcp.rcp_id desc
            </otherwise>
        </choose>
        limit #{pageSize} offset #{offset}
        ) r
        join rcp_ing ri
        on ri.rcp_id = r.rcp_id
        join ingredients i
        on i.ing_id = ri.ing_id
        left join user_ingredients ui
        on ui.user_id = #{userId}
        and ui.ing_id = ri.ing_id
        left join user_ingredients ui2
        on ui2.user_id = #{userId}
        and ui2.ing_id = ri.ing_id
        and DATEDIFF(CURRENT_DATE, ui2.created_at) >= 15;
    </select>


    <select id="getRecipesByKeyword" resultMap="RecipeListMap">
        SELECT
            r.rcp_id,
            r.rcp_name,
            r.rcp_img_url,
            r.rcp_view_count,
            r.level,
            r.match_rate,
            r.total_count,
            i.ing_id,
            i.ing_name,
            ui.ing_id as matched_ing_id,
            ui2.ing_id as redmatched_ing
        from (
        select rcp_id, rcp_name, rcp_img_url, rcp_view_count,level, count(*) over() as total_count,
        (
        select count(ui2.ing_id) / count(ri2.ing_id) * 100
        from rcp_ing ri2
        left join user_ingredients ui2
        on ui2.ing_id = ri2.ing_id
        and ui2.user_id = #{userId}
        where ri2.rcp_id = rcp.rcp_id
        ) as match_rate
        from rcp rcp
        where rcp_name like concat('%', #{keyword}, '%')
        <choose>
            <when test="sort == 'VIEW_DESC'">
                order by rcp_view_count desc
            </when>
            <when test="sort == 'LEVEL_DESC'">
                order by level desc
            </when>
            <when test="sort == 'MATCHRATE_DESC'">
                order by match_rate desc
            </when>
            <otherwise>
                order by rcp.rcp_id desc
            </otherwise>
        </choose>
        limit #{pageSize} offset #{offset}
        ) r
        join rcp_ing ri
            on ri.rcp_id = r.rcp_id
        join ingredients i
            on i.ing_id = ri.ing_id
        left join user_ingredients ui
            on ui.user_id = #{userId}
            and ui.ing_id = ri.ing_id
        left join user_ingredients ui2
            on ui2.user_id = #{userId}
            and ui2.ing_id = ri.ing_id
            and DATEDIFF(CURRENT_DATE, ui2.created_at) >= 15;
    </select>

    <!-- selectRecipeById 쿼리 추가 (누락되어 있었음!) -->
    <select id="selectRecipeById" parameterType="long" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        WHERE rcp_id = #{rcpId}
    </select>

    <!-- 전체 레시피 조회 -->
    <select id="selectAllRecipes" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        ORDER BY created_at DESC
    </select>

    <!-- 레시피명 검색 -->
    <select id="searchRecipesByName" parameterType="string" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        WHERE rcp_name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY rcp_name
    </select>

    <!-- 레시피 수정 -->
    <update id="updateRecipe" parameterType="com.korit.team_ljco.entity.Recipe">
        UPDATE rcp
        SET
        rcp_name = #{rcpName},
        rcp_img_url = #{rcpImgUrl},
        updated_at = CURRENT_TIMESTAMP
        WHERE rcp_id = #{rcpId}
    </update>

    <!-- 레시피 삭제 -->
    <delete id="deleteRecipe" parameterType="long">
        DELETE FROM rcp
        WHERE rcp_id = #{rcpId}
    </delete>

    <!-- 레시피 재료 삭제 -->
    <delete id="deleteRecipeIngredients" parameterType="long">
        DELETE FROM rcp_ing
        WHERE rcp_id = #{rcpId}
    </delete>

    <!-- 레시피 단계 조회 -->
    <select id="selectRecipeSteps" parameterType="long" resultMap="RecipeStepResultMap">
        SELECT
        step_id, rcp_id, step_no, step_desc, step_img_url, created_at
        FROM rcp_steps
        WHERE rcp_id = #{rcpId}
        ORDER BY step_no
    </select>

    <!-- 레시피 단계 삭제 -->
    <delete id="deleteRecipeSteps" parameterType="long">
        DELETE FROM rcp_steps
        WHERE rcp_id = #{rcpId}
    </delete>

</mapper>