<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.team_ljco.mapper.RecipeMapper">

    <!-- Recipe ResultMap Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏñ¥ ÏûàÏóàÏùå!) -->
    <resultMap id="RecipeResultMap" type="com.korit.team_ljco.entity.Recipe">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
    </resultMap>

    <!-- RecipeIngredient ResultMap Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏñ¥ ÏûàÏóàÏùå!) -->
    <resultMap id="RecipeIngredientResultMap" type="com.korit.team_ljco.entity.RecipeIngredient">
        <id property="rcpIngId" column="rcp_ing_id"/>
        <result property="rcpId" column="rcp_id"/>
        <result property="ingId" column="ing_id"/>
        <result property="rcpIngAmt" column="rcp_ing_amt"/>
        <result property="rcpIngOrd" column="rcp_ing_ord"/>
        <result property="createdAt" column="created_at"/>
        <result property="ingName" column="ing_name"/>
        <result property="ingImgUrl" column="ing_img_url"/>

        <result property="dDay" column="d_day"/>
        <result property="hasIng" column="has_ing"/>
    </resultMap>

    <!-- RecipeStep ResultMap Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏñ¥ ÏûàÏóàÏùå!) -->
    <resultMap id="RecipeStepResultMap" type="com.korit.team_ljco.entity.RecipeStep">
        <id property="stepId" column="step_id"/>
        <result property="rcpId" column="rcp_id"/>
        <result property="stepNo" column="step_no"/>
        <result property="stepDesc" column="step_desc"/>
        <result property="stepImgUrl" column="step_img_url"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <resultMap id="RecipeListWithIngredientsMap"
               type="com.korit.team_ljco.dto.RecipeListResponse">
        <id property="rcpId" column="rcp_id"/>
        <result property="rcpName" column="rcp_name"/>
        <result property="rcpImgUrl" column="rcp_img_url"/>
        <result property="rcpViewCount" column="rcp_view_count"/>
        <result property="level" column="level"/>
        <collection property="ingredients" ofType="com.korit.team_ljco.entity.RecipeIngredient">
            <result property="ingId" column="ing_id"/>
            <result property="ingName" column="ing_name"/>
        </collection>
    </resultMap>

    <!-- MatchRateÏö© ResultMap ÏàòÏ†ï -->
    <resultMap id="MatchRateMap" type="com.korit.team_ljco.dto.RecipeCount">
        <result property="recipeCount" column="recipe_count"/>
        <result property="myCount" column="my_count"/>
    </resultMap>

    <!-- getRecipes ÏøºÎ¶¨ ÏàòÏ†ï (Ïª¨ÎüºÎ™Ö Ïò§Î•ò ÏàòÏ†ï) -->
    <select id="getRecipes" resultMap="RecipeListWithIngredientsMap">
        SELECT
            r.rcp_id,
            r.rcp_name,
            r.rcp_img_url,
            r.rcp_view_count,
            r.level,
            i.ing_id,
            i.ing_name
        FROM (
            /* 1. Î®ºÏ†Ä Î†àÏãúÌîº ÌÖåÏù¥Î∏îÏóêÏÑú Ï§ëÎ≥µ ÏóÜÏù¥ 10Í∞úÎßå Í∞ÄÏ†∏ÏòµÎãàÎã§ */
            SELECT rcp_id, rcp_name, rcp_img_url, rcp_view_count, level
            FROM rcp
            ORDER BY rcp_id DESC
            LIMIT #{pageSize} OFFSET #{offset}
        ) r
        /* 2. ÏûòÎùºÎÇ∏ 10Í∞ú Î†àÏãúÌîºÏóê ÎåÄÌï¥ÏÑúÎßå Ïû¨Î£åÎ•º Ï°∞Ïù∏Ìï©ÎãàÎã§ */
        LEFT JOIN rcp_ing ri ON r.rcp_id = ri.rcp_id
        LEFT JOIN ingredients i ON ri.ing_id = i.ing_id
        ORDER BY r.rcp_id DESC
    </select>

    <!-- selectRecipeById ÏøºÎ¶¨ Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏñ¥ ÏûàÏóàÏùå!) -->
    <select id="selectRecipeById" parameterType="long" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        WHERE rcp_id = #{rcpId}
    </select>

    <!-- Ï†ÑÏ≤¥ Î†àÏãúÌîº Ï°∞Ìöå -->
    <select id="selectAllRecipes" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        ORDER BY created_at DESC
    </select>

    <!-- Î†àÏãúÌîºÎ™Ö Í≤ÄÏÉâ -->
    <select id="searchRecipesByName" parameterType="string" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        WHERE rcp_name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY rcp_name
    </select>

    <!-- Î†àÏãúÌîº Îì±Î°ù -->
    <insert id="insertRecipe" parameterType="com.korit.team_ljco.entity.Recipe"
            useGeneratedKeys="true" keyProperty="rcpId">
        INSERT INTO rcp (
        rcp_name, rcp_img_url
        ) VALUES (
        #{rcpName}, #{rcpImgUrl}
        )
    </insert>

    <!-- Î†àÏãúÌîº ÏàòÏ†ï -->
    <update id="updateRecipe" parameterType="com.korit.team_ljco.entity.Recipe">
        UPDATE rcp
        SET
        rcp_name = #{rcpName},
        rcp_img_url = #{rcpImgUrl},
        updated_at = CURRENT_TIMESTAMP
        WHERE rcp_id = #{rcpId}
    </update>

    <!-- Î†àÏãúÌîº ÏÇ≠Ï†ú -->
    <delete id="deleteRecipe" parameterType="long">
        DELETE FROM rcp
        WHERE rcp_id = #{rcpId}
    </delete>

    <!-- Î†àÏãúÌîº Ïû¨Î£å Ï°∞Ìöå -->
    <select id="selectRecipeIngredients" parameterType="long" resultMap="RecipeIngredientResultMap">
        SELECT
        ri.rcp_ing_id, ri.rcp_id, ri.ing_id, ri.rcp_ing_amt, ri.rcp_ing_ord,
        ri.created_at,
        i.ing_name, i.ing_img_url
        FROM rcp_ing ri
        INNER JOIN ing i ON ri.ing_id = i.ing_id
        WHERE ri.rcp_id = #{rcpId}
        ORDER BY ri.rcp_ing_ord
    </select>

    <!-- Î†àÏãúÌîº Ïû¨Î£å Îì±Î°ù -->
    <insert id="insertRecipeIngredient" parameterType="com.korit.team_ljco.entity.RecipeIngredient"
            useGeneratedKeys="true" keyProperty="rcpIngId">
        INSERT INTO rcp_ing (
        rcp_id, ing_id, rcp_ing_amt, rcp_ing_ord
        ) VALUES (
        #{rcpId}, #{ingId}, #{rcpIngAmt}, #{rcpIngOrd}
        )
    </insert>

    <!-- Î†àÏãúÌîº Ïû¨Î£å ÏÇ≠Ï†ú -->
    <delete id="deleteRecipeIngredients" parameterType="long">
        DELETE FROM rcp_ing
        WHERE rcp_id = #{rcpId}
    </delete>

    <!-- Î†àÏãúÌîº Îã®Í≥Ñ Ï°∞Ìöå -->
    <select id="selectRecipeSteps" parameterType="long" resultMap="RecipeStepResultMap">
        SELECT
        step_id, rcp_id, step_no, step_desc, step_img_url, created_at
        FROM rcp_steps
        WHERE rcp_id = #{rcpId}
        ORDER BY step_no
    </select>

    <!-- Î†àÏãúÌîº Îã®Í≥Ñ Îì±Î°ù -->
    <insert id="insertRecipeStep" parameterType="com.korit.team_ljco.entity.RecipeStep"
            useGeneratedKeys="true" keyProperty="stepId">
        INSERT INTO rcp_steps (
        rcp_id, step_no, step_desc, step_img_url
        ) VALUES (
        #{rcpId}, #{stepNo}, #{stepDesc}, #{stepImgUrl}
        )
    </insert>

    <!-- Î†àÏãúÌîº Îã®Í≥Ñ ÏÇ≠Ï†ú -->
    <delete id="deleteRecipeSteps" parameterType="long">
        DELETE FROM rcp_steps
        WHERE rcp_id = #{rcpId}
    </delete>

    <!-- Ï∂îÏ≤ú Î†àÏãúÌîº (ÏÇ¨Ïö©Ïûê Ïû¨Î£å Í∏∞Î∞ò) -->
    <select id="selectRecommendedRecipes" parameterType="long" resultType="map">
        SELECT
            r.rcp_id AS recipeId,
            r.rcp_name AS recipeName,
            r.rcp_img_url AS recipeImgUrl,
            COUNT(DISTINCT ri.ing_id) AS totalIngredients,
            COUNT(DISTINCT ui.ing_id) AS matchedIngredients,
            ROUND(COUNT(DISTINCT ui.ing_id) * 100.0 / COUNT(DISTINCT ri.ing_id), 2) AS matchPercentage
        FROM rcp r
            INNER JOIN rcp_ing ri ON r.rcp_id = ri.rcp_id
            LEFT JOIN user_ing ui ON ri.ing_id = ui.ing_id AND ui.user_id = #{userId}
            GROUP BY r.rcp_id
            HAVING matchedIngredients > 0
            ORDER BY matchPercentage DESC, matchedIngredients DESC
            LIMIT 20
    </select>

    <!-- Ïù∏Í∏∞ Î†àÏãúÌîº Ï°∞Ìöå (Ï°∞ÌöåÏàò Í∏∞Ï§Ä) -->
    <select id="selectTopRecipesByViews" parameterType="int" resultMap="RecipeResultMap">
        SELECT
        rcp_id, rcp_name, rcp_img_url,
        created_at, updated_at, rcp_view_count, level
        FROM rcp
        ORDER BY rcp_view_count DESC
        LIMIT #{limit}
    </select>

    <!-- Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE rcp
        SET rcp_view_count = COALESCE(rcp_view_count, 0) + 1
        WHERE rcp_id = #{rcpId}
    </update>

    <!-- Ï†ÑÏ≤¥ Î†àÏãúÌîº Í∞úÏàò Ï°∞Ìöå Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏñ¥ ÏûàÏóàÏùå!) -->
    <select id="countAllRecipes" resultType="int">
        SELECT COUNT(*)
        FROM rcp
    </select>

    <!-- getMatchRate ÏøºÎ¶¨ ÏàòÏ†ï (foreach Ï∂îÍ∞ÄÌïòÏó¨ Ïó¨Îü¨ rcpIds Ï≤òÎ¶¨) -->
    <select id="getMatchRate" resultMap="MatchRateMap">
        SELECT
        recipe_counts.rcp_id,
        recipe_counts.recipe_count,
        COALESCE(user_counts.my_count, 0) as my_count
        FROM (
        SELECT
        ri.rcp_id,
        COUNT(ri.ing_id) as recipe_count
        FROM rcp_ing ri
        WHERE ri.rcp_id IN
        <foreach collection="rcpIds" item="rcpId" open="(" separator="," close=")">
            #{rcpId}
        </foreach>
        GROUP BY ri.rcp_id
        ) recipe_counts
        LEFT JOIN (
        SELECT
        ri.rcp_id,
        COUNT(ri.ing_id) as my_count
        FROM rcp_ing ri
        INNER JOIN user_ing ui ON ui.ing_id = ri.ing_id
        WHERE ri.rcp_id IN
        <foreach collection="rcpIds" item="rcpId" open="(" separator="," close=")">
            #{rcpId}
        </foreach>
        AND ui.user_id = #{userId}
        GROUP BY ri.rcp_id
        ) user_counts ON recipe_counts.rcp_id = user_counts.rcp_id
    </select>
    <select id="searchRecipesByKeyword" resultMap="RecipeListWithIngredientsMap">
        SELECT
        r.rcp_id, r.rcp_name, r.rcp_img_url, r.rcp_view_count, r.level,
        i.ing_id, i.ing_name,
        /* üí° Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ: ÏÇ¨Ïö©ÏûêÏùò ÎÉâÏû•Í≥†ÏôÄ ÎåÄÏ°∞ÌïòÏó¨ D-Day Í≥ÑÏÇ∞ */
        DATEDIFF(CURRENT_TIMESTAMP, ui.created_at) AS d_day,
        CASE WHEN ui.user_ing_id IS NOT NULL THEN 1 ELSE 0 END AS has_ing
        FROM (
        SELECT rcp_id, rcp_name, rcp_img_url, rcp_view_count, level
        FROM rcp
        WHERE rcp_name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY rcp_id DESC
        LIMIT #{pageSize} OFFSET #{offset}
        ) r
        LEFT JOIN rcp_ing ri ON r.rcp_id = ri.rcp_id
        LEFT JOIN ingredients i ON ri.ing_id = i.ing_id
        /* üí° ÏÇ¨Ïö©ÏûêÏùò ÎÉâÏû•Í≥† Ïû¨Î£åÏôÄ Ï°∞Ïù∏ */
        LEFT JOIN user_ingredients ui ON i.ing_id = ui.ing_id AND ui.user_id = #{userId}
        ORDER BY r.rcp_id DESC
    </select>
</mapper>